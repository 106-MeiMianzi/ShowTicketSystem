<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mianzi.showticketsystem.mapper.OrderMapper">

<!--    声明这是一个插入数据库的操作-->
<!--    它与 OrderMapper.java 接口中的 int insert(Order order) 方法绑定-->
<!--    keyProperty:主键-->
<!--    useGeneratedKeys:使用生成主键-->
    <insert id="insert" keyProperty="id" useGeneratedKeys="true">
        INSERT INTO `order` (
            user_id, show_id, out_trade_no, quantity, total_price, status, order_time, create_time, update_time
        ) VALUES (
                     #{userId}, #{showId}, #{outTradeNo}, #{quantity}, #{totalPrice}, #{status}, #{orderTime}, #{createTime}, #{updateTime}
                 )
    </insert>

    <select id="getByIdAndUserId" resultType="com.mianzi.showticketsystem.model.entity.Order">
        SELECT
            id, user_id, show_id, out_trade_no, alipay_trade_no, quantity, total_price, status,
            order_time, pay_time, create_time, update_time
        FROM `order`
        WHERE id = #{id} AND user_id = #{userId}
    </select>

    <select id="getById" resultType="com.mianzi.showticketsystem.model.entity.Order">
        SELECT
            id, user_id, show_id, out_trade_no, alipay_trade_no, quantity, total_price, status,
            order_time, pay_time, create_time, update_time
        FROM `order`
        WHERE id = #{id}
    </select>

    <update id="updateStatus">
        UPDATE `order`
        SET
            status = #{newStatus},
            update_time = NOW()
        WHERE
            id = #{id}
          AND user_id = #{userId}
          AND status = #{expectedStatus}
    </update>

    <update id="updateStatusAndPayTime">
        UPDATE `order`
        SET
            status = #{newStatus},
            pay_time = NOW(),
            update_time = NOW()
        WHERE
            id = #{id}
          AND user_id = #{userId}
          AND status = #{expectedStatus}
    </update>

    <select id="countOrdersByUserId" resultType="int">
        SELECT COUNT(id)
        FROM `order`
        WHERE user_id = #{userId}
    </select>

    <select id="findOrdersByUserId" resultType="com.mianzi.showticketsystem.model.entity.Order">
        SELECT
            id, user_id, show_id, out_trade_no, alipay_trade_no, quantity, total_price, status,
            order_time, pay_time, create_time, update_time
        FROM `order`
        WHERE user_id = #{userId}
        ORDER BY order_time DESC
            LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countAllOrders" resultType="int">
        SELECT COUNT(id)
        FROM `order`
    </select>

    <select id="findAllOrders" resultType="com.mianzi.showticketsystem.model.entity.Order">
        SELECT
            id, user_id, show_id, out_trade_no, alipay_trade_no, quantity, total_price, status,
            order_time, pay_time, create_time, update_time
        FROM `order`
        ORDER BY order_time DESC
            LIMIT #{limit} OFFSET #{offset}
    </select>

    <update id="adminUpdateStatus">
        UPDATE `order`
        SET
            status = #{newStatus},
            update_time = NOW()
        WHERE id = #{orderId}
    </update>

    <select id="getByOutTradeNo" resultType="com.mianzi.showticketsystem.model.entity.Order">
        SELECT
            id, user_id, show_id, out_trade_no, alipay_trade_no, quantity, total_price, status,
            order_time, pay_time, create_time, update_time
        FROM `order`
        WHERE out_trade_no = #{outTradeNo}
    </select>

    <update id="updateAlipayTradeNo">
        UPDATE `order`
        SET
            alipay_trade_no = #{alipayTradeNo},
            update_time = NOW()
        WHERE id = #{orderId}
    </update>

    <select id="findOrdersByUserIdWithConditions" resultType="com.mianzi.showticketsystem.model.entity.Order">
        SELECT
            id, user_id, show_id, out_trade_no, alipay_trade_no, quantity, total_price, status,
            order_time, pay_time, create_time, update_time
        FROM `order`
        WHERE user_id = #{userId}
        <if test="status != null">
            AND status = #{status}
        </if>
        ORDER BY order_time DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countOrdersByUserIdWithConditions" resultType="long">
        SELECT COUNT(id)
        FROM `order`
        WHERE user_id = #{userId}
        <if test="status != null">
            AND status = #{status}
        </if>
    </select>

    <select id="findOrdersForAdmin" resultType="com.mianzi.showticketsystem.model.entity.Order">
        SELECT
            id, user_id, show_id, out_trade_no, alipay_trade_no, quantity, total_price, status,
            order_time, pay_time, create_time, update_time
        FROM `order`
        <where>
            <if test="userId != null">
                AND user_id = #{userId}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
        ORDER BY order_time DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countOrdersForAdmin" resultType="long">
        SELECT COUNT(id)
        FROM `order`
        <where>
            <if test="userId != null">
                AND user_id = #{userId}
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
    </select>

    <select id="findPendingOrdersBefore" resultType="com.mianzi.showticketsystem.model.entity.Order">
        SELECT
            id, user_id, show_id, out_trade_no, alipay_trade_no, quantity, total_price, status,
            order_time, pay_time, create_time, update_time
        FROM `order`
        WHERE status = 1 AND order_time &lt;= #{beforeTime}
    </select>

</mapper>