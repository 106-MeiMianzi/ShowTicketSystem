<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mianzi.showticketsystem.mapper.OrderMapper">

<!--    声明这是一个插入数据库的操作-->
<!--    它与 OrderMapper.java 接口中的 int insert(Order order) 方法绑定-->
<!--    keyProperty:主键-->
<!--    useGeneratedKeys:使用生成主键-->
    <insert id="insert" keyProperty="id" useGeneratedKeys="true">
--     插入订单表
        INSERT INTO `order` (
--             字段列表： 这是你要为新记录提供值的所有列名。数据将按照这个顺序被填入
            user_id, show_id, quantity, total_price, status, order_time, create_time, update_time
--                 VALUES 表示接下来会提供与上方字段列表一一对应的值
        ) VALUES (
--          MyBatis 参数占位符:会从你传入 OrderMapper.insert(Order order) 方法
--          的那个 Order 实体对象中，通过反射机制自动获取对应属性的值
                     #{userId}, #{showId}, #{quantity}, #{totalPrice}, #{status}, #{orderTime}, #{createTime}, #{updateTime}
                 )
    </insert>

    <select id="getByIdAndUserId" resultType="com.mianzi.showticketsystem.model.entity.Order">
        SELECT
            id, user_id, show_id, quantity, total_price, status,
            order_time, pay_time, create_time, update_time
        FROM `order`
        WHERE id = #{id} AND user_id = #{userId}
    </select>

    <update id="updateStatus">
        UPDATE `order`
        SET
            status = #{newStatus},
            update_time = NOW()
        WHERE
            id = #{id}
          AND user_id = #{userId}
          AND status = #{expectedStatus}
    </update>

    <update id="updateStatusAndPayTime">
        UPDATE `order`
        SET
            status = #{newStatus},
            pay_time = NOW(),
            update_time = NOW()
        WHERE
            id = #{id}
          AND user_id = #{userId}
          AND status = #{expectedStatus}
    </update>

    <select id="countOrdersByUserId" resultType="int">
        SELECT COUNT(id)
        FROM `order`
        WHERE user_id = #{userId}
    </select>

    <select id="findOrdersByUserId" resultType="com.mianzi.showticketsystem.model.entity.Order">
        SELECT
            id, user_id, show_id, quantity, total_price, status,
            order_time, pay_time, create_time, update_time
        FROM `order`
        WHERE user_id = #{userId}
        ORDER BY order_time DESC
            LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countAllOrders" resultType="int">
        SELECT COUNT(id)
        FROM `order`
    </select>

    <select id="findAllOrders" resultType="com.mianzi.showticketsystem.model.entity.Order">
        SELECT
            id, user_id, show_id, quantity, total_price, status,
            order_time, pay_time, create_time, update_time
        FROM `order`
        ORDER BY order_time DESC
            LIMIT #{limit} OFFSET #{offset}
    </select>

    <update id="adminUpdateStatus">
        UPDATE `order`
        SET
            status = #{newStatus},
            update_time = NOW()
        WHERE id = #{orderId}
    </update>

</mapper>