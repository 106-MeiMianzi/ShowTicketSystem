<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mianzi.showticketsystem.mapper.OrderMapper">

    <insert id="insert" keyProperty="id" useGeneratedKeys="true">
        INSERT INTO `order` (
            user_id, show_id, quantity, total_price, status, order_time, create_time, update_time
        ) VALUES (
                     #{userId}, #{showId}, #{quantity}, #{totalPrice}, #{status}, #{orderTime}, #{createTime}, #{updateTime}
                 )
    </insert>

    <select id="getByIdAndUserId" resultType="com.mianzi.showticketsystem.model.entity.Order">
        SELECT
            id, user_id, show_id, quantity, total_price, status,
            order_time, pay_time, create_time, update_time
        FROM `order`
        WHERE id = #{id} AND user_id = #{userId}
    </select>

    <update id="updateStatus">
        UPDATE `order`
        SET
            status = #{newStatus},
            update_time = NOW()
        WHERE
            id = #{id}
          AND user_id = #{userId}
          AND status = #{expectedStatus}
    </update>

    <update id="updateStatusAndPayTime">
        UPDATE `order`
        SET
            status = #{newStatus},
            pay_time = NOW(),
            update_time = NOW()
        WHERE
            id = #{id}
          AND user_id = #{userId}
          AND status = #{expectedStatus}
    </update>

    <select id="countOrdersByUserId" resultType="int">
        SELECT COUNT(id)
        FROM `order`
        WHERE user_id = #{userId}
    </select>

    <select id="findOrdersByUserId" resultType="com.mianzi.showticketsystem.model.entity.Order">
        SELECT
            id, user_id, show_id, quantity, total_price, status,
            order_time, pay_time, create_time, update_time
        FROM `order`
        WHERE user_id = #{userId}
        ORDER BY order_time DESC
            LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countAllOrders" resultType="int">
        SELECT COUNT(id)
        FROM `order`
    </select>

    <select id="findAllOrders" resultType="com.mianzi.showticketsystem.model.entity.Order">
        SELECT
            id, user_id, show_id, quantity, total_price, status,
            order_time, pay_time, create_time, update_time
        FROM `order`
        ORDER BY order_time DESC
            LIMIT #{limit} OFFSET #{offset}
    </select>

    <update id="adminUpdateStatus">
        UPDATE `order`
        SET
            status = #{newStatus},
            update_time = NOW()
        WHERE id = #{orderId}
    </update>

</mapper>